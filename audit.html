<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Audit Fiabilisation</title>

  <!-- Firebase v8 SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    h1, h2 { text-align: center; }

    input, button, textarea, select {
      margin: 8px 0;
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      table-layout: fixed;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      word-wrap: break-word;
    }

    th:first-child, td:first-child {
      width: 35%;
      text-align: left;
    }

    th:nth-child(2), td:nth-child(2),
    th:nth-child(3), td:nth-child(3),
    th:nth-child(4), td:nth-child(4) {
      width: 10%;
    }

    th:last-child, td:last-child {
      width: 35%;
    }

    #auditForm { display: none; }
    .status { margin: 10px 0; font-weight: bold; }
  </style>
</head>
<body>

  <h1>Connexion Ã  l'Audit</h1>

  <div id="loginForm">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Mot de passe">
    <button onclick="login()">Se connecter</button>
    <div id="loginStatus" class="status"></div>
  </div>

  <div id="auditForm">
    <h2>Formulaire dâ€™Audit</h2>
    <input type="text" id="technicien" placeholder="Nom du technicien">
    <input type="text" id="societe" placeholder="SociÃ©tÃ©">
    <input type="date" id="date">
    <input type="time" id="heure">
    <input type="text" id="auditeur" placeholder="Auditeur">
    <input type="text" id="nro" placeholder="NRO">
    <textarea id="commentaire" placeholder="Commentaire gÃ©nÃ©ral..."></textarea>

    <table id="auditTable">
      <thead>
        <tr>
          <th>Point de ContrÃ´le</th>
          <th>Oui</th>
          <th>Non</th>
          <th>Pas Ã©valuÃ©</th>
          <th>Commentaire</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <p class="status" id="resultats">Total Oui: 0 | Total Non: 0 | Pas Ã©valuÃ©: 0 | % de OK: 0%</p>

    <button onclick="calculerResultats()">ðŸ“Š Calculer RÃ©sultats</button>
    <button onclick="envoyerAudit()">ðŸ“¤ Envoyer l'audit</button>
    <button onclick="logout()">ðŸ”’ Se dÃ©connecter</button>
    <div id="auditStatus" class="status"></div>
  </div>

  <script>
    // ðŸ”§ Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDf_1g1OZKOexqkqV3uKWh6_c2myMBQcHU",
      authDomain: "audit-nro-pmgc.firebaseapp.com",
      projectId: "audit-nro-pmgc",
      storageBucket: "audit-nro-pmgc.appspot.com",
      messagingSenderId: "800784852735",
      appId: "1:800784852735:web:d551ae9d4fab3d6b20ceca"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Points de contrÃ´le
    const points = [
  "Retard ou absence injustifiÃ©e",
  "PrÃ©sence dâ€™un autre technicien prestataire non prÃ©vu",
  "Comportement professionnel du prestataire",
  "Port des EPI (gants, lunettes, chaussures, etc.)",
  "Habilitations requises disponibles",
  "PrÃ©sence des Ã©quipements nÃ©cessaires",
  "Respect des procÃ©dures dâ€™accÃ¨s au NRO",
  "CapacitÃ© Ã  se repÃ©rer dans le NRO",
  "CapacitÃ© Ã  identifier les types de BRK, pictels, tiroirs",
  "CapacitÃ© Ã  rÃ©cupÃ©rer les informations ROP",
  "CapacitÃ© Ã  envoyer le signal laser",
  "Communication efficace avec le technicien terrain",
  "Mesure du signal au BRK",
  "InterprÃ©tation correcte des valeurs mesurÃ©es",
  "CapacitÃ© Ã  identifier les causes dâ€™une mauvaise mesure",
  "RemontÃ©e des anomalies dÃ©tectÃ©es",
  "Proposition dâ€™une solution provisoire pertinente",
  "Prise des photos demandÃ©es de maniÃ¨re optimale",
  "Photo de la baie passive et du tiroir",
  "Photo du signal BRK",
  "Photo du retour laser du PB",
  "Tiroir en baie opÃ©rateur avec BRK",
  "Photo du signal en baie opÃ©rateur",
  "Envoi des photos au technicien terrain",

  // âœ… Nouveaux points de contrÃ´le
  "Adopte une attitude respectueuse et professionnelle avec les gardiens et les habitants Ã  lâ€™adresse",
  "Se repÃ¨re facilement pour localiser le point de branchement (PB)",
  "Isole rapidement la fibre et prÃ©pare efficacement les tests",
  "Utilise aisÃ©ment les applications logicielles pour repÃ©rer ou valider sa ROP",
  "Assure une bonne qualitÃ© de communication avec le NRO",
  "Met en place un pictel pour le renvoi laser vers le NRO",
  "Installe lâ€™Ã‰pibox et Ã©tiquette correctement avec la rÃ©fÃ©rence PTO",
  "Fournit des photos conformes et de bonne qualitÃ© prises Ã  lâ€™adresse",
  "RÃ©alise un dÃ©briefing clair et complet",
  "Assure une bonne communication et transmission des informations avec les BO"
];

    const tbody = document.getElementById("tableBody");

    points.forEach((pt, i) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${pt}</td>
        <td><input type="radio" name="q${i}" value="oui"></td>
        <td><input type="radio" name="q${i}" value="non"></td>
        <td><input type="radio" name="q${i}" value="na"></td>
        <td><input type="text" name="comment${i}"></td>
      `;
      tbody.appendChild(row);
    });

    function calculerResultats() {
      let oui = 0, non = 0, na = 0;
      points.forEach((_, i) => {
        const val = document.querySelector(`input[name="q${i}"]:checked`);
        if (!val) return;
        if (val.value === "oui") oui++;
        else if (val.value === "non") non++;
        else na++;
      });
      const total = oui + non + na;
      const percent = total ? Math.round((oui / total) * 100) : 0;
      document.getElementById("resultats").textContent =
        `Total Oui: ${oui} | Total Non: ${non} | Pas Ã©valuÃ©: ${na} | % de OK: ${percent}%`;
    }

    function envoyerAudit() {
  const user = auth.currentUser;
  if (!user) return;

  // RÃ©cupÃ©ration des champs
  const technicien = document.getElementById('technicien').value.trim();
  const societe = document.getElementById('societe').value.trim();
  const date = document.getElementById('date').value;
  const heure = document.getElementById('heure').value;
  const auditeur = document.getElementById('auditeur').value.trim();
  const nro = document.getElementById('nro').value.trim();
  const commentaire = document.getElementById('commentaire').value.trim();

  let erreurs = [];

  // VÃ©rification des champs obligatoires
  if (!technicien) erreurs.push("ðŸ›‘ Le nom du technicien est requis.");
  if (!societe) erreurs.push("ðŸ›‘ La sociÃ©tÃ© est requise.");
  if (!date) erreurs.push("ðŸ›‘ La date est requise.");
  if (!heure) erreurs.push("ðŸ›‘ L'heure est requise.");
  if (!auditeur) erreurs.push("ðŸ›‘ Le nom de l'auditeur est requis.");
  if (!nro) erreurs.push("ðŸ›‘ Le NRO est requis.");

  // VÃ©rification des points de contrÃ´le
  const controles = [];
  points.forEach((pt, i) => {
    const val = document.querySelector(`input[name="q${i}"]:checked`);
    const comment = document.querySelector(`input[name="comment${i}"]`).value.trim();

    if (!val) {
      erreurs.push(`ðŸ›‘ Point "${pt}" non Ã©valuÃ©.`);
    }

    // Si rÃ©ponse "non", commentaire obligatoire
    if (val && val.value === "non" && !comment) {
      erreurs.push(`ðŸ›‘ Commentaire requis pour le point "${pt}" (Ã©valuation = Non).`);
    }

    controles.push({
      point: pt,
      evaluation: val ? val.value : "non dÃ©fini",
      commentaire: comment
    });
  });

  // Affichage des erreurs
  if (erreurs.length > 0) {
    alert("Erreur de validation :\n\n" + erreurs.join("\n"));
    return;
  }

  // Si tout est bon, on envoie Ã  Firestore
  const audit = {
    technicien,
    societe,
    date,
    heure,
    auditeur,
    nro,
    commentaire,
    utilisateur: user.email,
    timestamp: new Date(),
    controles
  };

  db.collection("audits").add(audit)
    .then(() => {
      document.getElementById('auditStatus').textContent = "âœ… Audit enregistrÃ© avec succÃ¨s !";
    })
    .catch((err) => {
      document.getElementById('auditStatus').textContent = "âŒ Erreur : " + err.message;
    });
}


    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          document.getElementById('loginStatus').textContent = "âœ… ConnectÃ©";
        })
        .catch((error) => {
          document.getElementById('loginStatus').textContent = "âŒ " + error.message;
        });
    }

    function logout() {
      auth.signOut().then(() => {
        document.getElementById('loginStatus').textContent = "ðŸ”’ DÃ©connectÃ©";
        document.getElementById('auditStatus').textContent = "";
      });
    }

    auth.onAuthStateChanged((user) => {
      if (user) {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('auditForm').style.display = 'block';
      } else {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('auditForm').style.display = 'none';
      }
    });
  </script>
</body>
</html>
